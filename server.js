require("dotenv").config();
const express = require("express");
const http = require("http");
const { Server } = require("socket.io");
const cors = require("cors");
const path = require("path");
const fs = require("fs");
const jwt = require("jsonwebtoken");
const { pool, initDB } = require("./database");

const app = express();
const server = http.createServer(app);
const io = new Server(server, { cors: { origin: "*" }, maxHttpBufferSize: 10e6 });

const PORT = process.env.PORT || 3000;
const JWT_SECRET = process.env.JWT_SECRET || "change_me";
const UPLOAD_DIR = path.join(__dirname, "uploads");
if (!fs.existsSync(UPLOAD_DIR)) fs.mkdirSync(UPLOAD_DIR, { recursive: true });

app.use(cors());
app.use(express.json({ limit: "12mb" }));
app.use(express.static(path.join(__dirname, "public")));
app.use("/uploads", express.static(UPLOAD_DIR));

function authMiddleware(req, res, next) {
  const h = req.headers.authorization;
  if (!h || !h.startsWith("Bearer ")) return res.status(401).json({ error: "No token" });
  try { req.user = jwt.verify(h.split(" ")[1], JWT_SECRET); next(); }
  catch { return res.status(401).json({ error: "Invalid token" }); }
}
function adminMiddleware(req, res, next) {
  if (!req.user || req.user.role !== "admin") return res.status(403).json({ error: "Admin required" });
  next();
}

app.set("pool", pool);
app.set("io", io);
app.set("jwt_secret", JWT_SECRET);
app.set("authMiddleware", authMiddleware);
app.set("adminMiddleware", adminMiddleware);

app.use("/api/auth", require("./routes/auth"));
app.use("/api/chats", require("./routes/chats"));
app.use("/api/admin", require("./routes/admin"));
app.use("/api/payment", require("./routes/payment"));
app.use("/api/upload", require("./routes/upload"));

// â”€â”€ Socket.io â”€â”€
io.use((socket, next) => {
  const token = socket.handshake.auth?.token;
  if (!token) return next(new Error("Auth required"));
  try { socket.user = jwt.verify(token, JWT_SECRET); next(); }
  catch { next(new Error("Invalid token")); }
});

const onlineUsers = new Map();
io.on("connection", (socket) => {
  const uid = socket.user.id;
  onlineUsers.set(uid, socket.id);
  io.emit("online_users", Array.from(onlineUsers.keys()));
  socket.join(`user_${uid}`);

  socket.on("typing", (data) => {
    if (data.chatId) {
      pool.query("SELECT user_id FROM chat_members WHERE chat_id=$1 AND user_id!=$2", [data.chatId, uid])
        .then(({ rows }) => rows.forEach(r => io.to(`user_${r.user_id}`).emit("typing", { chatId: data.chatId, userId: uid, name: socket.user.email })))
        .catch(() => {});
    }
  });

  socket.on("disconnect", () => {
    onlineUsers.delete(uid);
    io.emit("online_users", Array.from(onlineUsers.keys()));
  });
});

app.get("*", (req, res) => res.sendFile(path.join(__dirname, "public", "index.html")));

(async () => {
  try {
    await initDB();
    server.listen(PORT, () => {
      console.log(`\n  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`);
      console.log(`  â•‘  ğŸ“ˆ DrFX Quantum v5.0 on port ${PORT}       â•‘`);
      console.log(`  â•‘  PostgreSQL âœ… Â· Telegram-style         â•‘`);
      console.log(`  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);
    });
  } catch (err) { console.error("âŒ Start failed:", err); process.exit(1); }
})();
